@model IEnumerable<ManvarFitness.Entity.SubConcerns>
<style>
    /* OFF state */
    .form-check-input {
        background-color: #ccc; /* gray when OFF */
        border-radius: 1rem; /* keep default Bootstrap rounded */
        transition: background-color 0.4s;
    }

        /* ON state */
        .form-check-input:checked {
            background-color: #FF7F11; /* orange when ON */
        }
</style>
@{
    ViewData["Title"] = "Sub Concerns List";
}
@Html.AntiForgeryToken()
<h2>@ViewData["Title"]</h2>

<a asp-action="Create" class="btn btn-success mb-3">Add Sub Concern</a>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th class="width:30%">Sub Concern</th>
            <th class="width:30%">Main Concern</th>
            <th class="width:20%">Status</th>
            <th class="width:20%">Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Name</td>
                <td>@item.Concern?.Name</td>
                <td>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input toggle-status"
                               type="checkbox"
                               data-id="@item.SubConcernId"
                               id="switch_@item.SubConcernId"
                               @(item.IsActive ? "checked" : "") />
                        <label class="form-check-label" for="switch_@item.SubConcernId"></label>
                    </div>
                </td>
                <td>

                    <!-- Delete -->
                    <button type="button" class="btn btn-sm" style="color:darkorange;"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteModal"
                            onclick="setDeleteId(@item.SubConcernId)">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-sm">
            <div class="modal-header bg-light">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this Sub Concern?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteSubConcern()">Delete</button>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>
        let selectedSubConcernId = 0;

        // Set ID when clicking Delete button
        function setDeleteId(id) {
            selectedSubConcernId = id;
        }

        // Delete Sub Concern (Soft Delete)
        function deleteSubConcern() {
            if (selectedSubConcernId === 0) {
                alert("Invalid Sub Concern.");
                return;
            }

            fetch(`/SubConcern/SoftDelete?id=${selectedSubConcernId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert("Delete failed.");
                }
            })
            .catch(error => {
                console.error("Delete Error:", error);
                alert("Something went wrong.");
            });
        }
        document.querySelectorAll(".toggle-status").forEach(toggle => {

            toggle.addEventListener("change", function () {

                const id = this.getAttribute("data-id");
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const checkbox = this;

                fetch(`/SubConcern/Toggle?id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    }
                })
                .then(response => {

                    if (!response.ok) {
                        alert("Status update failed");
                        checkbox.checked = !checkbox.checked; // revert if error
                    }

                })
                .catch(() => {
                    alert("Error updating status");
                    checkbox.checked = !checkbox.checked; // revert if error
                });

            });

        });
    </script>
}

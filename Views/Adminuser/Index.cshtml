@model IEnumerable<ManvarFitness.Entity.AdminUser>
<style>
    /* OFF state */
    .form-check-input {
        background-color: #ccc; /* gray when OFF */
        border-radius: 1rem; /* keep default Bootstrap rounded */
        transition: background-color 0.4s;
    }

        /* ON state */
        .form-check-input:checked {
            background-color: #FF7F11; /* orange when ON */
        }
</style>

<h1 class="fw-semibold mb-3" style="display: inline-block; color: #333; padding-bottom: 4px; border-bottom: 3px solid #FF7F11; border-radius: 2px;">Admin Users</h1>
<div class="container-fluid px-4">
    <div id="addUserContainer"  class="d-flex justify-content-between align-items-center mt-4 mb-3 d-none">
        <a asp-controller="AdminUser"
           asp-action="Create"
           class="btn btn-success px-4 py-2 fw-semibold">
            Add New User
        </a>
    </div>

    <!-- Search & Filters -->
    <div class="row mt-3 mb-3">
        <div class="col-lg-3 col-md-4">
            <div class="input-group">
                @* <div class="position-relative"> *@
                    <input type="text" id="searchPlan" class="form-control" placeholder="Search User..." />
                    <span id="clearSearchBtn"
                          style="position: absolute; right: 50px; top: 20%; transform: translateY(-30%);
                             cursor: pointer; display: none; color: black; font-size: 1.1rem;">&times;</span>
                    <button class="btn btn-outline-secondary" type="button" id="searchIconBtn">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- TABLE -->
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th class="d-none d-md-table-cell" style="width:10%">ID</th>
                    <th style="width:20%">EmailUsername</th>
                    <th class="d-none d-md-table-cell" style="width:10%">Password</th>
                    <th style="width:15%">Role</th>
                    <th style="width:15%">Mobile</th>
                    <th style="width:10%">Status</th>
                    <th style="width:20%">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td class="d-none d-md-table-cell">@user.Id</td>
                        <td >@user.EmailUsername</td>
                        <td class="d-none d-md-table-cell position relative">
                            <span id="password-@user.Id"class="masked-password">
                                ••••••••
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-2">

                                <!-- Role Text -->
                                <span class="role-text" id="role-text-@user.Id">
                                    @user.Role
                                </span>

                                <!-- Dropdown (Hidden by default) -->
                                <select class="form-select form-select-sm role-dropdown d-none"
                                        data-userid="@user.Id"
                                        id="role-select-@user.Id"
                                        style="width:120px;">

                                    <option value="Admin" selected="@(user.Role == "Admin" ? "selected" : null)">
                                        Admin
                                    </option>

                                    <option value="Coach" selected="@(user.Role == "Coach" ? "selected" : null)">
                                        Coach
                                    </option>
                                </select>

                                <button type="button"
                                        class="btn btn-sm btn-light border"
                                        onclick="enableRoleEdit(@user.Id)"
                                        style="padding:4px 6px; color:darkorange">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>


                            </div>
                        </td>


                        <td>
                            <span class="fw-semibold">@user.CountryCode</span>
                            <span>@user.Mobile</span>
                        </td>

                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" data-userid="@user.Id"
                                       @(user.IsActive ? "checked" : "") >
                                <label class="form-check-label" for="switchCheckDefault"></label>
                            </div>


                        </td>
                        <td>
                            <div class="d-flex gap-2">

                                <!-- Details -->
                                <a asp-action="Details"
                                   asp-route-id="@user.Id"
                                   class="btn btn-sm btn-light border"
                                   title="Details">
                                    <i class="bi bi-eye-fill text-warning"></i>
                                </a>

                                <!-- Edit -->
                                <a asp-action="Edit"
                                   asp-route-id="@user.Id"
                                   class="btn btn-sm btn-light border"
                                   title="Edit">
                                    <i class="bi bi-pencil-fill text-warning"></i>
                                </a>

                                <!-- Delete -->
                                <a asp-action="Delete"
                                   asp-route-id="@user.Id"
                                   class="btn btn-sm btn-light border"
                                   title="Delete">
                                    <i class="bi bi-trash-fill text-warning"></i>
                                </a>

                            </div>

                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
@section Scripts {
    <script>
               const searchPlan = document.getElementById("searchPlan");
        const searchIconBtn = document.getElementById("searchIconBtn");
        const addUserContainer = document.getElementById("addUserContainer");
        const clearSearchBtn = document.getElementById("clearSearchBtn");

        // Filter table rows based on search input
        function filterUsers() {
            const rows = document.querySelectorAll("table tbody tr");
            const searchText = searchPlan.value.toLowerCase().trim();
            let anyMatch = false;

            rows.forEach(row => {
                const matches = row.innerText.toLowerCase().includes(searchText);
                row.style.display = matches ? "" : "none";
                if (matches) anyMatch = true;
            });

            // Show Add button **only if user types 'addnewuser'**
            if (!anyMatch && searchText === "addnewuser") {
                addUserContainer.classList.remove("d-none");
            } else {
                addUserContainer.classList.add("d-none");
            }
        }

        // Show/hide clear button
        searchPlan.addEventListener("input", function() {
            if (this.value.trim() !== "") clearSearchBtn.style.display = "inline";
            else clearSearchBtn.style.display = "none";

            filterUsers();
        });

        // Clear input when clicking ×
        clearSearchBtn.addEventListener("click", function() {
            searchPlan.value = "";
            clearSearchBtn.style.display = "none";
            filterUsers();
            searchPlan.focus();
        });

        // Search icon click: just filter table, DO NOT show Add button
        searchIconBtn.addEventListener("click", function() {
            filterUsers();
        });

        // Toggle Active Status
        function toggleActive(el) {
            const userId = el.dataset.userid;
            const isActive = el.checked;

            fetch(`/AdminUser/ToogleActive/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({ isActive })
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to update status.');
                    el.checked = !isActive;
                }
            })
            .catch(err => {
                console.error(err);
                el.checked = !isActive;
            });
        }

        document.querySelectorAll(".form-check-input").forEach(switchEl => {
            switchEl.addEventListener("change", function () {
                toggleActive(this);
            });
        });

        // Role Edit
        function enableRoleEdit(userId) {
            const roleTextEl = document.getElementById("role-text-" + userId);
            const roleDropdown = document.getElementById("role-select-" + userId);

            roleDropdown.dataset.originalRole = roleTextEl.innerText.trim();
            roleTextEl.classList.add("d-none");
            roleDropdown.classList.remove("d-none");
            roleDropdown.focus();
        }

        document.querySelectorAll(".role-dropdown").forEach(dropdown => {
            dropdown.addEventListener("change", function() {
                const userId = this.dataset.userid;
                const selectedRole = this.value;
                const roleTextEl = document.getElementById("role-text-" + userId);

                const confirmChange = confirm(`Are you sure you want to change this user's role to "${selectedRole}"?`);
                if (!confirmChange) {
                    this.value = this.dataset.originalRole;
                    this.classList.add("d-none");
                    roleTextEl.classList.remove("d-none");
                    return;
                }

                fetch(`/AdminUser/UpdateRole/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ role: selectedRole })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        roleTextEl.innerText = selectedRole;
                        this.dataset.originalRole = selectedRole;
                    } else {
                        alert("Role update failed!");
                        this.value = this.dataset.originalRole;
                    }
                    this.classList.add("d-none");
                    roleTextEl.classList.remove("d-none");
                })
                .catch(err => {
                    console.error(err);
                    alert("Error updating role.");
                    this.value = this.dataset.originalRole;
                    this.classList.add("d-none");
                    roleTextEl.classList.remove("d-none");
                });
            });
        });
    </script>
}



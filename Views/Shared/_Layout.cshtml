@using System.Text.RegularExpressions
@using ManvarFitness.Database
@inject ApplicationDbContext _context

@{
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
    var role = Context.Session.GetString("UserRole");
    var userName = Context.Session.GetString("UserName") ?? "User";
    // for pages
    var allowedPageUrls = _context.RolePages
        .Where(rp => rp.RoleName == role && rp.IsActive)
        .Join(_context.Pages,
              rp => rp.PageId,
              p => p.Id,
              (rp, p) => p.Url)
        .ToList();

    bool HasAccess(string controller, string action = "Index")
    {
        return allowedPageUrls.Contains($"/{controller}/{action}");
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - ManwarFitness</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    @await RenderSectionAsync("VendorStyles", required: false)
</head>
<body>

    <header class="topbar">
        <div class="topbar-left">
            <button class="menu-btn" id="menuToggle"> ☰ </button> 
            <img src="~/img/IMG_5797.JPG (1).jpeg" alt="Logo" class="logo" />
            <span><b>Mawvar Fitness</b></span>
        </div>

        <div class="dropdown text-end position-relative">
            <a class="d-flex align-items-center justify-content-center text-decoration-none dropdown-toggle"
               href="#" id="profileDropdown" data-bs-toggle="dropdown">
                👤
            </a>

            <div class="dropdown-menu dropdown-menu-end shadow p-0 mt-2 border-0 rounded-3"
                 aria-labelledby="profileDropdown" style="min-width: 200px;">
                <div class="card border-0 rounded-3">
                    <div class="card-body p-3" style="background-color: #fff;">
                        <h6 class="card-title mb-2" style="color: #333;">Name: @userName</h6>

                        <h6 class="card-title mb-2" style="color: #333;">Role: @role</h6>

                        <form method="post" asp-controller="Auth" asp-action="Logout">
                            <button type="submit" class="btn w-100 fw-semibold text-white"
                                    style="background-color: #FF7F11; border-radius: 8px; transition: background 0.3s;">
                                Logout
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard">
        <aside class="sidebar" id="sidebar">
            <ul>
                @if (HasAccess("Dashboard"))
                {
                    <li class="@(currentController == "Dashboard" ? "active" : "")">
                        <a asp-controller="Dashboard" asp-action="Index">Dashboard</a>
                    </li>
                }

                @if (HasAccess("Customers") || HasAccess("AdminUser") || HasAccess("UserRoles") || HasAccess("RoleMenu"))
                {
                    <li class="dropdown-li@(currentController == "Customers" ? "active" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#usersSubmenu">
                            Users
                        </a>

                        <ul class="collapse list-unstyled ps-3 @(currentController == "Customers" || currentController == "AdminUser" || currentController == "UserRoles" || currentController == "RoleMenu" ? "show" : "")"
                            id="usersSubmenu">

                            @if (HasAccess("Customers"))
                            {
                                <li class="@(currentController == "Customers" ? "active" : "")">
                                    <a asp-controller="Customers" asp-action="Index">Customers</a>
                                </li>
                            }

                            @if (HasAccess("AdminUser"))
                            {
                                <li class="@(currentController == "AdminUser" ? "active" : "")">
                                    <a asp-controller="AdminUser" asp-action="Index">Admin Users</a>
                                </li>
                            }

                            @if (HasAccess("UserRoles"))
                            {
                                <li class="@(currentController == "UserRoles" ? "active" : "")">
                                    <a asp-controller="UserRoles" asp-action="Index">Roles</a>
                                </li>
                            }

                            @if (HasAccess("RoleMenu"))
                            {
                                <li class="@(currentController == "RoleMenu" ? "active" : "")">
                                    <a asp-controller="RoleMenu" asp-action="Index">Role Menu Assign</a>
                                </li>
                            }
                        </ul>
                    </li>
                }

                @if (HasAccess("Result"))
                {
                    <li class="dropdown-li@(currentController == "Result" ? "activeparent" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#resultsSubmenu">
                            Result
                        </a>

                        <ul class="collapse list-unstyled ps-3 @(currentController == "Result" ? "show" : "")"
                            id="resultsSubmenu">

                            @if (HasAccess("Result"))
                            {
                                <li class="@(currentController == "Result" ? "active" : "")">
                                    <a asp-controller="Result" asp-action="Index">Result Overview</a>
                                </li>
                            }
                        </ul>
                    </li>
                }

               
                @if (HasAccess("ConcernCategory") || HasAccess("SubConcern") || HasAccess("CustomForm"))
                {
                    <li class="dropdown-li@(currentController == "ConcernCategory" || currentController == "SubConcern" || currentController == "CustomForm" ? "activeparent" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#concernsSubmenu">
                            Concerns
                        </a>

                        <ul class="collapse list-unstyled ps-3 @(currentController == "ConcernCategory" || currentController == "SubConcern" || currentController == "CustomForm" ? "show" : "")"
                            id="concernsSubmenu">

                            @if (HasAccess("ConcernCategory"))
                            {
                                <li class="@(currentController == "ConcernCategory" ? "active" : "")">
                                    <a asp-controller="ConcernCategory" asp-action="Index">Main Concerns</a>
                                </li>
                            }

                            @if (HasAccess("SubConcern"))
                            {
                                <li class="@(currentController == "SubConcern" ? "active" : "")">
                                    <a asp-controller="SubConcern" asp-action="Index">Sub Concerns </a>
                                </li>
                            }

                            @if (HasAccess("CustomForm"))
                            {

                                <li class="@(currentController == "CustomForm" ? "active" : "")">
                                    <a asp-controller="CustomForm" asp-action="Index"> Custom Form </a>
                                </li>
                            }
                        </ul>
                    </li>
                }

                @if (HasAccess("Diet") || HasAccess("DietPlan"))
                {
                    <li class="dropdown-li @(currentController == "Diet" || currentController == "DietPlan" ? "active-parent" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#dietSubmenu">
                            Diet Plans
                        </a>

                        <ul class="collapse list-unstyled ps-3 @(currentController == "Diet" || currentController == "DietPlan" ? "show" : "")"
                            id="dietSubmenu">
@* 
                            @if (HasAccess("Diet"))
                            {
                                <li class="@(currentController == "Diet" ? "active" : "")">
                                    <a asp-controller="Diet" asp-action="Index">Diet Overview</a>
                                </li>
                            } *@

                            @if (HasAccess("DietPlan"))
                            {
                                <li class="@(currentController == "DietPlan" ? "active" : "")">
                                    <a asp-controller="DietPlan" asp-action="Index">Diet Plan</a>
                                </li>
                            }  
                        </ul>
                    </li>
                }

                @if (HasAccess("Workout", "Videos") || HasAccess("YogaExercise") || HasAccess("Meditation"))
                {
                    <li class="dropdown-li @(currentController == "Workout" || currentController == "YogaExercise" || currentController == "Meditation" ? "active-parent" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#workoutSubmenu">
                            Workouts
                        </a>

                        <ul class="collapse list-unstyled ps-3 @(currentController == "Workout" || currentController == "YogaExercise" || currentController == "Meditation" ? "show" : "")"
                            id="workoutSubmenu">

                            @if (HasAccess("Workout", "Videos"))
                            {
                                <li class="@(currentController == "Workout" ? "active" : "")">
                                    <a asp-controller="Workout" asp-action="Videos">Workout Videos</a>
                                </li>
                            }

                            @*  @if (HasAccess("YogaExercise"))
                            {
                                <li class="@(currentController == "YogaExercise" ? "active" : "")">
                                    <a asp-controller="YogaExercise" asp-action="Index">Yoga & Exercises</a>
                                </li>
                            }

                            @if (HasAccess("Meditation"))
                            {
                                <li class="@(currentController == "Meditation" ? "active" : "")">
                                    <a asp-controller="Meditation" asp-action="Index">Meditation Music</a>
                                </li>
                            } *@
                        </ul>
                    </li>
                }

                @if (HasAccess("Herbs") || HasAccess("HerbsCategory"))
                {
                    <li class="dropdown-li@(currentController == "Herbs" || currentController == "HerbsCategory" ? "activeparent" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#herbsSubmenu">
                            Herbs
                        </a>
                        <ul class="collapse list-unstyled ps-3 @(currentController == "Herbs" || currentController == "HerbsCategory" ? "show" : "")"
                            id="herbsSubmenu">

                           @*  @if (HasAccess("Herbs"))
                            {
                                <li class="@(currentController == "Herbs" ? "active" : "")">
                                    <a asp-controller="Herbs" asp-action="Index">Herbs Overview</a>
                                </li>
                            } *@

                            @if (HasAccess("HerbsCategory"))
                            {
                                <li class="@(currentController == "HerbsCategory" ? "active" : "")">
                                    <a asp-controller="HerbsCategory" asp-action="Index">Herbs Category</a>
                                </li>
                            }
                        </ul>
                    </li>
                }

                @if (HasAccess("Revenue") || HasAccess("Payments"))
                {
                    <li class="dropdown-li@(currentController == "Revenue" || currentController == "Payments" ? "activeparent" : "")">
                        <a href="#" class="dropdown-toggle" data-bs-toggle="collapse" data-bs-target="#revenueSubmenu">
                            Revenue
                        </a>

                        <ul class="collapse list-unstyled ps-3 @(currentController == "Revenue" || currentController == "Payments" ? "show" : "")"
                            id="revenueSubmenu">

                            @if (HasAccess("Revenue"))
                            {
                                <li class="@(currentController == "Revenue" ? "active" : "")">
                                    <a asp-controller="Revenue" asp-action="Index">Revenue Overview</a>
                                </li>
                            }

                            @*  @if (HasAccess("Payments"))
                            {
                                <li class="@(currentController == "Payments" ? "active" : "")">
                                    <a asp-controller="Payments" asp-action="Index">Payments</a>
                                </li>
                            }  *@
                        </ul>
                    </li>
                }

            </ul>
        </aside>

        <main class="content">
            @RenderBody()
        </main>

    </div>

    <script>
        // Sidebar toggle
        document.getElementById("menuToggle").addEventListener("click", function () {
            document.getElementById("sidebar").classList.toggle("active");
        });

        // Session timeout
        var timeoutMinutes = 15; // set your timeout minutes
        var timeoutMilliseconds = timeoutMinutes * 60 * 1000;
        var inactivityTimer;

        function resetTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(function() {
                alert("Session expired due to inactivity.");
            }, timeoutMilliseconds);
        }

        window.onload = resetTimer;
        document.onmousemove = resetTimer;
        document.onkeypress = resetTimer;
        document.onclick = resetTimer;
        document.onscroll = resetTimer;
    </script>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>